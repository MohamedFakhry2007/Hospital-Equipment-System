{% extends "base.html" %}

{% block title %}Training Management{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col">
            <h2>Training Management</h2>
        </div>
        <div class="col text-end">
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTrainingModal">
                <i class="fas fa-plus"></i> Add New Training
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover" id="trainingTable">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Employee ID</th>
                    <th>Name</th>
                    <th>Department</th>
                    <th>Trainer</th>
                    <th>Trained On Machines</th>
                    <th>Last Trained</th>
                    <th>Next Due</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if trainings %}
                    {% for training in trainings %}
                    <tr id="training-row-{{ training.id }}">
                        <td>{{ loop.index }}</td>
                        <td>{{ training.employee_id }}</td>
                        <td>{{ training.name }}</td>
                        <td>{{ training.department }}</td>
                        <td>{{ training.trainer }}</td>
                        <td>
                            {% if training.trained_on_machines %}
                                {{ training.trained_on_machines|join(', ') }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>{{ training.last_trained_date if training.last_trained_date else 'N/A' }}</td>
                        <td>{{ training.next_due_date if training.next_due_date else 'N/A' }}</td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-training-btn"
                                    data-id="{{ training.id }}"
                                    data-employee-id="{{ training.employee_id }}"
                                    data-name="{{ training.name }}"
                                    data-department="{{ training.department }}"
                                    data-trainer="{{ training.trainer }}"
                                    data-machines="{{ training.trained_on_machines|join(',') }}"
                                    data-last-trained="{{ training.last_trained_date if training.last_trained_date else '' }}"
                                    data-next-due="{{ training.next_due_date if training.next_due_date else '' }}"
                                    data-bs-toggle="modal" data-bs-target="#editTrainingModal">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger delete-training-btn" data-id="{{ training.id }}" data-name="{{ training.name }}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="9" class="text-center">No training records found.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Training Modal -->
<div class="modal fade" id="addTrainingModal" tabindex="-1" aria-labelledby="addTrainingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTrainingModalLabel">Add New Training Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTrainingForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="addEmployeeId" class="form-label">Employee ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addEmployeeId" name="employee_id" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="addName" class="form-label">Employee Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addName" name="name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="addDepartment" class="form-label">Department</label>
                            <select class="form-select" id="addDepartment" name="department">
                                <option value="">Select Department</option>
                                {% for dept in departments %}
                                    <option value="{{ dept }}">{{ dept }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="addTrainer" class="form-label">Training Module</label>
                            <select class="form-select" id="addTrainer" name="trainer">
                                <option value="">Select Training Module</option>
                                {% for module in training_modules %}
                                    <option value="{{ module }}">{{ module }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="addTrainedOnMachines" class="form-label">Trained On Machines</label>
                        <select class="form-select" id="addTrainedOnMachines" name="trained_on_machines" multiple size="6">
                            {% for device in all_devices %}
                                <option value="{{ device }}">{{ device }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple machines. Machines will be filtered by department selection.</small>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="addLastTrainedDate" class="form-label">Last Trained Date</label>
                            <input type="date" class="form-control" id="addLastTrainedDate" name="last_trained_date">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="addNextDueDate" class="form-label">Next Due Date</label>
                            <input type="date" class="form-control" id="addNextDueDate" name="next_due_date">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" form="addTrainingForm">Save Training</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Training Modal -->
<div class="modal fade" id="editTrainingModal" tabindex="-1" aria-labelledby="editTrainingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTrainingModalLabel">Edit Training Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTrainingForm">
                    <input type="hidden" id="editTrainingId" name="id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editEmployeeId" class="form-label">Employee ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editEmployeeId" name="employee_id" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editName" class="form-label">Employee Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editName" name="name" required>
                        </div>
                    </div>                     <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editDepartment" class="form-label">Department</label>
                            <select class="form-select" id="editDepartment" name="department">
                                <option value="">Select Department</option>
                                {% for dept in departments %}
                                    <option value="{{ dept }}">{{ dept }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editTrainer" class="form-label">Training Module</label>
                            <select class="form-select" id="editTrainer" name="trainer">
                                <option value="">Select Training Module</option>
                                {% for module in training_modules %}
                                    <option value="{{ module }}">{{ module }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editTrainedOnMachines" class="form-label">Trained On Machines</label>
                        <select class="form-select" id="editTrainedOnMachines" name="trained_on_machines" multiple size="6">
                            {% for device in all_devices %}
                                <option value="{{ device }}">{{ device }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple machines. Machines will be filtered by department selection.</small>
                    </div>
                     <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editLastTrainedDate" class="form-label">Last Trained Date</label>
                            <input type="date" class="form-control" id="editLastTrainedDate" name="last_trained_date">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editNextDueDate" class="form-label">Next Due Date</label>
                            <input type="date" class="form-control" id="editNextDueDate" name="next_due_date">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" form="editTrainingForm">Save Changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Department-based device filtering
const devicesByDepartment = {{ devices_by_department|tojson }};

function filterDevicesByDepartment(departmentSelect, devicesSelect) {
    const selectedDepartment = departmentSelect.value;
    const devicesOptions = devicesSelect.querySelectorAll('option');
    
    // Show all devices if no department selected
    if (!selectedDepartment) {
        devicesOptions.forEach(option => {
            option.style.display = 'block';
        });
        return;
    }
    
    // Get devices for selected department
    const departmentDevices = devicesByDepartment[selectedDepartment] || [];
    
    // Show/hide devices based on department
    devicesOptions.forEach(option => {
        if (option.value === '' || departmentDevices.includes(option.value)) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });
    
    // Clear selection of hidden devices
    Array.from(devicesSelect.selectedOptions).forEach(option => {
        if (option.style.display === 'none') {
            option.selected = false;
        }
    });
}

// Add event listeners for department changes
document.addEventListener('DOMContentLoaded', function() {
    const addDepartmentSelect = document.getElementById('addDepartment');
    const addDevicesSelect = document.getElementById('addTrainedOnMachines');
    const editDepartmentSelect = document.getElementById('editDepartment');
    const editDevicesSelect = document.getElementById('editTrainedOnMachines');
    
    if (addDepartmentSelect && addDevicesSelect) {
        addDepartmentSelect.addEventListener('change', function() {
            filterDevicesByDepartment(this, addDevicesSelect);
        });
    }
    
    if (editDepartmentSelect && editDevicesSelect) {
        editDepartmentSelect.addEventListener('change', function() {
            filterDevicesByDepartment(this, editDevicesSelect);
        });
    }
});
</script>
<script src="{{ url_for('static', filename='js/training.js') }}"></script>
{% endblock %}
